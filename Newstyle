(vl-load-com) ;; Loads ActiveX functions into AutoLISP

;; UnFormat String function by Lee Mac
(defun LM:UnFormat (str mtx / _replace rx)
  (defun _replace (new old str)
    (vlax-put-property rx 'pattern old)
    (vlax-invoke rx 'replace str new)
  )
  (if (setq rx (vlax-get-or-create-object "VBScript.RegExp"))
    (progn
      (setq str
        (vl-catch-all-apply
          (function
            (lambda ()
              (vlax-put-property rx 'global actrue)
              (vlax-put-property rx 'multiline actrue)
              (vlax-put-property rx 'ignorecase acfalse)
              (foreach pair
                '(
                  ("\032" . "\\\\\\\\")
                  (" " . "\\\\P|\\n|\\t")
                  ("$1" . "\\\\(\\\\[ACcFfHLlOopQTW])|\\\\[ACcFfHLlOopQTW][^\\\\;]*;|\\\\[ACcFfHLlOopQTW]")
                  ("$1$2/$3" . "([^\\\\])\\\\S([^;]*)[/#\\^]([^;]*);")
                  ("$1$2" . "\\\\(\\\\S)|[\\\\](})|}")
                  ("$1" . "[\\\\]({)|{")
                )
                (setq str (_replace (car pair) (cdr pair) str))
              )
              (if mtx
                (_replace "\\\\" "\032" (_replace "\\$1$2$3" "(\\\\[ACcFfHLlOoPpQSTW])|({)|(})" str))
                (_replace "\\" "\032" str)
              )
            )
          )
        )
      )
      (vlax-release-object rx)
      (if (null (vl-catch-all-error-p str))
        str
      )
    )
  )
)

;; Function to unformat cell content in all tables
(defun c:UnformatAllCells (/ tbl tblobj row col cellcontent unformattedcontent)
  (vl-load-com)
  ;; Get all table objects in the drawing
  (setq tbl (vla-get-ModelSpace (vla-get-ActiveDocument (vlax-get-Acad-Object))))
  (setq tbl (vlax-invoke tbl 'select '("Table")))
  ;; Iterate through all table objects
  (vlax-for tblobj tbl
    (if (eq (vla-get-ObjectName tblobj) "AcDbTable")
      (progn
        ;; Loop through all rows and columns in the table
        (foreach row (vlax-for rownum (vlax-invoke tblobj 'getrows))
          (foreach col (vlax-for colnum (vlax-invoke tblobj 'getcolumns))
            ;; Get the cell content
            (setq cellcontent (vla-gettext tblobj rownum colnum))
            ;; Unformat the cell content using the UnFormat function
            (setq unformattedcontent (LM:UnFormat cellcontent nil))
            ;; Set the unformatted content back to the cell
            (vla-settext tblobj rownum colnum unformattedcontent)
          )
        )
      )
    )
  )
  ;; Update the drawing to reflect changes
  (vla-update (vla-get-ActiveDocument (vlax-get-Acad-Object)))
  (princ "\nUnformatted all cells in all tables.")
)

(princ "\nType UnformatAllCells to unformat the content of all cells in all tables.")
(princ)
